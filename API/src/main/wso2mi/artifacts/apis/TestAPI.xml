<api xmlns="http://ws.apache.org/ns/synapse" name="TestAPI" context="/testapi">
    <resource methods="POST">
        <inSequence>
            <!-- Ensure JSON message format -->
            <property name="messageType" value="application/json" scope="axis2"/>
            <property name="NO_ENTITY_BODY" scope="axis2" action="remove"/>

            <!-- Store incoming JSON array -->
            <property name="originalPayload" scope="default" expression="json-eval($)" type="JSON"/>

            <payloadFactory media-type="json">
                <format>            
                    [{"id":3, "name":"Course 3"}, {"id":4, "name":"Course 4"}]            
                </format>
                <args/>
            </payloadFactory>

            <enrich>
                <source clone="true" xpath="json-eval($)"/>
                <target property="extraCourses" type="property"/>
            </enrich>

            <enrich>
                <source clone="true" property="originalPayload" type="property"/>
                <target type="body"/>
            </enrich>

            <foreach id="foreach_1" expression="json-eval($ctx:extraCourses)">
                <sequence>
                    <log>
                        <property expression="json-eval($)" name="Extra Course ########### "/>
                    </log>

                    <property name="content" expression="json-eval($)"/>
                    <enrich>
                        <source clone="true" property="content" type="property"/>
                        <target action="child" type="custom" xpath="json-eval($)"/>
                    </enrich>
                </sequence>
            </foreach>
            <respond/>
        </inSequence>
    </resource>
</api>
