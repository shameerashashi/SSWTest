<api xmlns="http://ws.apache.org/ns/synapse" name="TestAPI" context="/testapi">
    <resource methods="POST">
        <inSequence>
            <!-- Ensure JSON message format -->
            <property name="messageType" value="application/json" scope="axis2"/>

            <property value="https://wso2test.free.beeceptor.com/data" name="uri.var.GetCourseData" scope="default" type="STRING"/>
	
            <call>
		        <endpoint key="GetCourseDataEndpoint"/>
	        </call>

            <log>
                <property name="message" value="After get course data"/>
                <property expression="json-eval($)" name="response_Json"/>
            </log>

                <script description="Transform response" language="js">
                   <![CDATA[var data = mc.getPayloadJSON();
                      var resultArray = [];
                      for(var i = 0; i < data.length; i++) {
                          var srcCode = "";
                          var memIdnum = "";
                          if (data[i].genericRecord && data[i].genericRecord.genericRecordId) {
                              srcCode = data[i].genericRecord.genericRecordId.srcCode || "";
                              memIdnum = data[i].genericRecord.genericRecordId.memIdnum || "";
                              var recordObj = {
                                  "genericRecord": {
                                      "genericRecordId": {
                                          "srcCode": srcCode,
                                          "memIdnum": memIdnum
                                      }
                                  },
                                  "score": data[i].score
                              };
                              resultArray.push(recordObj);   
                            } 
                      }             
                  	  mc.setPayloadJSON(resultArray);
                  	]]>
                    </script>
            <respond/>
        </inSequence>
    </resource>
</api>
